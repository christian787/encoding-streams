<!DOCTYPE html><html lang="en-US"><meta charset="utf-8">
<meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport">
<meta content="#3c790a" name="theme-color">
<title>Changes to the Encoding Standard to support the Stream Standard</title>
<link href="https://resources.whatwg.org/standard.css" rel="stylesheet">
<link href="https://resources.whatwg.org/logo-encoding.svg" rel="icon">
<script defer id="head" src="https://html.spec.whatwg.org/dfn.js"></script>
<style>
.addition {
  font-weight: bold;
  color: #00bb00;
  margin-left: -0.5em;
}
</style>

<div class="head">

<h1>Changes to the <a href="https://encoding.spec.whatwg.org">Encoding
Standard</a> to support the <a href="https://streams.spec.whatwg.org/">Stream
Standard</a></h1>

<dl>
 <dt>On Github:
 <dd><a href="https://github.com/ricea/encoding-streams">Repository</a>
 (<a href="https://github.com/ricea/encoding-streams/issues">open issues</a>)
</dl>

</div>

<h3>In 8.1, Interface <code title="">TextDecoder</code>:</h3>

<p class="addition">In the IDL, add

<p><pre class="idl">
 static <a class="external" data-anolis-spec="streams" href="https://streams.spec.whatwg.org/#ts">TransformStream</a> <a href="#dom-textdecoder-stream" title="dom-TextDecoder-stream">stream</a>(optional DOMString <var>label</var> = "utf-8", optional <a href="https://encoding.spec.whatwg.org/#textdecoderoptions">TextDecoderOptions</a> <var>options</var>);
</pre>

<p class="addition">to the TextDecoder interface.

<p class="addition">To the DOM intro note, add

<p><dl class="domintro">
  <dt><code><var>stream</var> = <a href="https://encoding.spec.whatwg.org/#dom-textdecoder" title="dom-TextDecoder">TextDecoder</a>
  . <a href="#dom-textdecoder-stream" title="dom-TextDecoder-stream">stream</a>([<var>label</var> = "utf-8" [, <var>options</var>]])</code>
  <dd>
    <p>Returns a new <a href="https://streams.spec.whatwg.org/#ts"><code class="external" data-anolis-spec="streams">TransformStream</code></a> object that can be used to convert a stream of
    bytes in the specified encoding to a stream of strings. <var>label</var> and <var>options</var>
    are handled as with the <a href="https://encoding.spec.whatwg.org/#textdecoder"><code>TextDecoder</code></a> constructor.
    <p class="note no-backref">This is a static class method, not an object method.
</dl>

<p class="addition">After the definition of the decode() method, add:

<p>The
<dfn id="dom-textdecoder-stream" title="dom-TextDecoder-stream"><code>stream(<var>label</var>, <var>options</var>)</code></dfn>
method, when invoked, must run these steps:

<ol>
 <li><p>Let <var>encoding</var> be the result of
 <a href="https://encoding.spec.whatwg.org/#concept-encoding-get" title="concept-encoding-get">getting an encoding</a> from
 <var>label</var>.

 <li><p>If <var>encoding</var> is failure or <a href="https://encoding.spec.whatwg.org/#replacement">replacement</a>,
 <a class="external" data-anolis-spec="webidl" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-rangeerror"><code class="external" data-anolis-spec="ecmascript">RangeError</code></a>.

 <li><p>Let <var>transformer</var> be a new object with an associated
 <dfn id="slot-td-transformer-decoder" title="slot-TD-transformer-decoder"><b>decoder</b></dfn>,
 <dfn id="slot-td-transformer-stream" title="slot-TD-transformer-stream"><b>stream</b></dfn>,
 <dfn id="slot-td-transformer-ignore-bom-flag" title="slot-TD-transformer-ignore-BOM-flag"><b>ignore BOM flag</b></dfn> (initially unset),
 <dfn id="slot-td-transformer-bom-seen-flag" title="slot-TD-transformer-BOM-seen-flag">BOM seen flag</dfn> (initially unset), and
 <dfn id="slot-td-transformer-error-mode" title="slot-TD-transformer-error-mode"><b>error mode</b></dfn> (initially
 "<code title="">replacement</code>").

 <li><p>If <var>options</var>'s <code title="">fatal</code> member is true,
 set <var>transformer</var>'s <a href="#slot-td-transformer-error-mode" title="slot-TD-transformer-error-mode"><b>error mode</b></a> to
 "<code>fatal</code>".

 <li><p>If <var>options</var>'s <code title="">ignoreBOM</code> member is true,
 set <var>transformer</var>'s <a href="#slot-td-transformer-ignore-bom-flag" title="slot-TD-transformer-ignore-BOM-flag"><b>ignore BOM
 flag</b></a>.

 <li><p>Set <a href="#slot-td-transformer-decoder" title="slot-TD-transformer-decoder"><b>decoder</b></a> to a
 new <var>encoding</var>'s <a href="https://encoding.spec.whatwg.org/#decoder">decoder</a>.

 <li><p>Set <a href="#slot-td-transformer-stream" title="slot-TD-transformer-stream"><b>stream</b></a> to a
 new <a href="https://encoding.spec.whatwg.org/#concept-stream" title="concept-stream">stream</a>

 <li><p>Set <var>transformer</var>["transform"] to a function which
 takes <var>chunk</var>, <var>controller</var> arguments and runs the
 <a href="#concept-td-decode-and-enqueue" title="concept-TD-decode-and-enqueue">decode and
 enqueue a chunk</a> algorithm on the <var>transformer</var> object.

 <li><p>Set <var>transform</var>["flush"] to a function which
 takes a <var>controller</var> argument and runs
 the <a href="#concept-td-flush-and-enqueue" title="concept-TD-flush-and-enqueue">flush and enqueue</a> algorithm on
 the <var>transformer</var> object.

 <li><p>Let <var>t</var> be the result of calling the initial value of
 <a href="https://streams.spec.whatwg.org/#ts"><code class="external" data-anolis-spec="streams">TransformStream</code></a> as a constructor
 with <var>transformer</var>.

 <li><p>Return <var>t</var>.
</ol>

<p>The <dfn id="concept-td-decode-and-enqueue" title="concept-TD-decode-and-enqueue">decode and enqueue a chunk</dfn> algorithm, which
transforms a chunk of data to a string, runs these steps:

<ol>
 <li><p><a href="https://encoding.spec.whatwg.org/#concept-stream-push" title="concept-stream-push">Push</a> a
 <a class="external" data-anolis-spec="webidl" href="https://heycam.github.io/webidl/#dfn-get-buffer-source-copy" title="get a copy of the bytes held by the buffer source">copy
 of</a> <var>chunk</var> to <var>transformer</var>'s
 <a href="#slot-td-transformer-stream" title="slot-TD-transformer-stream"><b>stream</b></a>.

 <li><p>Let <var>output</var> be a new <a href="https://encoding.spec.whatwg.org/#concept-stream" title="concept-stream">stream</a>.

 <li>
  <p>While true, run these substeps:

  <ol>
   <li><p>Let <var>token</var> be the result of
   <a href="https://encoding.spec.whatwg.org/#concept-stream-read" title="concept-stream-read">reading</a>
   from <var>transformer</var>'s <a href="#slot-td-transformer-stream" title="slot-TD-transformer-stream"><b>stream</b></a>.

   <li>
    <p>If <var>token</var> is <a href="https://encoding.spec.whatwg.org/#end-of-stream">end-of-stream</a>,
    <ol>
     <li><p><a class="external" data-anolis-spec="ecmascript" href="https://tc39.github.io/ecma262/#sec-invoke">Invoke</a> the <var>enqueue</var> method of
     the <var>controller</var> object,
     passing <var>output</var>, <a href="https://encoding.spec.whatwg.org/#concept-td-serialize" title="concept-TD-serialize">serialized</a>, as the sole
     argument.
     <li><p>Return.
    </ol>

   <li>
    <p>Otherwise, run these subsubsteps:

    <ol>
     <li><p>Let <var>result</var> be the result of
     <a href="https://encoding.spec.whatwg.org/#concept-encoding-process" title="concept-encoding-process">processing</a> <var>token</var> for
     <var>transformer</var>'s <a href="#slot-td-transformer-decoder" title="slot-TD-transformer-decoder"><b>decoder</b></a>
     and <a href="#slot-td-transformer-stream" title="slot-TD-transformer-stream"><b>stream</b></a>, <var>output</var>,
     and <var>transformer</var>'s <a href="#slot-td-transformer-error-mode" title="slot-TD-transformer-error-mode"><b>error
     mode</b></a>.

     <li><p>If <var>result</var> is <a href="https://encoding.spec.whatwg.org/#error">error</a>,
     <a class="external" data-anolis-spec="webidl" href="https://heycam.github.io/webidl/#dfn-throw" title="throw">throw</a>
     a <a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror"><code class="external" data-anolis-spec="ecmascript">TypeError</code></a> exception.

     <li><p>Otherwise, do nothing.
    </ol>
  </ol>
</ol>

<p>The <dfn id="concept-td-flush-and-enqueue" title="concept-TD-flush-and-enqueue">flush and enqueue</dfn> algorithm, which handles the
end of data from the input <a href="https://streams.spec.whatwg.org/#rs-class"><code class="external" data-anolis-spec="streams">ReadableStream</code></a>, runs these steps:

<ol>
  <li><p>Let <var>output</var> be a new <a href="https://encoding.spec.whatwg.org/#concept-stream" title="concept-stream">stream</a>.

  <li><p>Let <var>result</var> be the result of
  <a href="https://encoding.spec.whatwg.org/#concept-encoding-process" title="concept-encoding-process">processing</a> <a href="https://encoding.spec.whatwg.org/#end-of-stream">end-of-stream</a> for
  <var>transformer</var>'s <a href="#slot-td-transformer-decoder" title="slot-TD-transformer-decoder"><b>decoder</b></a>
  and <a href="#slot-td-transformer-stream" title="slot-TD-transformer-stream"><b>stream</b></a>, <var>output</var>,
  and <a href="#slot-td-transformer-error-mode" title="slot-TD-transformer-error-mode"><b>error mode</b></a>.

  <li><p>If <var>result</var> is <a href="https://encoding.spec.whatwg.org/#finished">finished</a>,
  <ol>
    <li><p><a class="external" data-anolis-spec="ecmascript" href="https://tc39.github.io/ecma262/#sec-invoke">Invoke</a> the <var>enqueue</var> method of
    the <var>controller</var> object,
    passing <var>output</var>, <a href="https://encoding.spec.whatwg.org/#concept-td-serialize" title="concept-TD-serialize">serialized</a>, as the sole
    argument.
   <li><p>Return.
  </ol>

  <li><p>Otherwise,
  <a class="external" data-anolis-spec="webidl" href="https://heycam.github.io/webidl/#dfn-throw" title="throw">throw</a>
  a <a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror"><code class="external" data-anolis-spec="ecmascript">TypeError</code></a>.
</ol>

<h3>In 8.2 Interface <code title="">TextEncoder</code>, add:</h3>

<p class="addition">In the IDL, add

<p><pre class="idl">
  static <a class="external" data-anolis-spec="streams" href="https://streams.spec.whatwg.org/#ts">TransformStream</a> <a href="#dom-textencoder-stream" title="dom-TextEncoder-stream">stream</a>();
</pre>

<p class="addition">to the TextEncoder interface.

<p class="addition">To the DOM intro note, add

<p><dl class="domintro">
 <dt><code><a href="https://encoding.spec.whatwg.org/#dom-textencoder" title="dom-TextEncoder">TextEncoder</a> . <a href="#dom-textencoder-stream" title="dom-TextEncoder-stream">stream</a>()</code>
 <dd><p>Returns a new <a href="https://streams.spec.whatwg.org/#ts"><code class="external" data-anolis-spec="streams">TransformStream</code></a> object that can be used to convert a stream of
     strings to a stream of bytes in the <a href="https://encoding.spec.whatwg.org/#utf-8">UTF-8</a> encoding.
     <p class="note no-backref">This is a static class method, not an object
     method.
</dl>

<p class="addition">After the definition of the encode() method, add:

<p>The
<dfn id="dom-textencoder-stream" title="dom-TextEncoder-stream"><code>stream()</code></dfn> method, when invoked, must run these
steps:

<ol>
 <li><p>Let <var>transformer</var> be a new object.

 <li><p>Set <var>tranformer</var>["transform"] to a function which
 takes <var>chunk</var>, <var>controller</var> arguments and performs the following steps:

 <ol>
  <li><p>Convert <var>chunk</var> to a <a href="https://encoding.spec.whatwg.org/#concept-stream" title="concept-stream">stream</a>.

  <li><p>Let <var>output</var> be a new <a href="https://encoding.spec.whatwg.org/#concept-stream" title="concept-stream">stream</a>.

  <li><p>Let <var>encoder</var> be <a href="https://encoding.spec.whatwg.org/#utf-8">UTF-8</a>'s <a href="https://encoding.spec.whatwg.org/#encoder">encoder</a>.

  <li><p>While true, run these substeps:

<!-- TODO(ricea): This algorithm cannot deal with having a surrogate pair split between two
chunks. This is consistent with TextEncoder.encode() but arguably is a worse limitation in the
streaming case. -->

  <ol>
   <li><p>Let <var>token</var> be the result of
   <a href="https://encoding.spec.whatwg.org/#concept-stream-read" title="concept-stream-read">reading</a> from <var>chunk</var>.

   <li><p>Let <var>result</var> be the result of
   <a href="https://encoding.spec.whatwg.org/#concept-encoding-process" title="concept-encoding-process">processing</a> <var>token</var> for
   <var>encoder</var>, <var>input</var>, <var>output</var>.

   <li><p>If <var>result</var> is finished, run these substeps:
   <ol>
    <li><p>Convert <var>output</var> into a byte sequence.

    <li><p><a class="external" data-anolis-spec="ecmascript" href="https://tc39.github.io/ecma262/#sec-invoke">Invoke</a> the <var>enqueue</var> method of
    the <var>controller</var> object, passing a <a href="https://tc39.github.io/ecma262/#sec-typedarray-objects"><code class="external" data-anolis-spec="ecmascript">Uint8Array</code></a>
    object wrapping an <a href="https://tc39.github.io/ecma262/#sec-arraybuffer-objects"><code class="external" data-anolis-spec="ecmascript">ArrayBuffer</code></a>
    containing <var>output</var>, as the sole argument.

    <li><p>Return.
   </ol>
  </ol>
 </ol>

 <li><p>Let <var>t</var> be the result of calling the initial value of <a href="https://streams.spec.whatwg.org/#ts"><code class="external" data-anolis-spec="streams">TransformStream</code></a>
 as a constructor with <var>transformer</var>.

 <li><p>Return <var>t</var>.
</ol>
