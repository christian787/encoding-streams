<!DOCTYPE html><html lang="en-US"><meta charset="utf-8">
<meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport">
<meta content="#3c790a" name="theme-color">
<title>Changes to the Encoding Standard to support the Stream Standard</title>
<link href="https://resources.whatwg.org/standard.css" rel="stylesheet">
<link href="https://resources.whatwg.org/logo-encoding.svg" rel="icon">
<script defer id="head" src="https://html.spec.whatwg.org/dfn.js"></script>
<style>
.addition {
  font-weight: bold;
  color: #00bb00;
  margin-left: -0.5em;
}
</style>

<div class="head">

<h1>Changes to the <a href="https://encoding.spec.whatwg.org">Encoding
Standard</a> to support the <a href="https://streams.spec.whatwg.org/">Stream
Standard</a></h1>

<dl>
 <dt>On Github:
 <dd><a href="https://github.com/ricea/encoding-streams">Repository</a>
 (<a href="https://github.com/ricea/encoding-streams/issues">open issues</a>)
</dl>

</div>

<h3>In 8.1, Interface <code title="">TextDecoder</code>:</h3>

<p class="addition">In the IDL, add

<p><pre class="idl highlight def">
  <span class="kt">readonly</span> <span class="kt">attribute</span> <a class="n" data-link-type="idl-name" href="https://streams.spec.whatwg.org/#rs-class">ReadableStream</a> <a class="nv idl-code" data-link-type="attribute" data-readonly="" data-type="ReadableStream" href="#dom-textdecoder-readable">readable</a>;
  <span class="kt">readonly</span> <span class="kt">attribute</span> <a class="n" data-link-type="idl-name" href="https://streams.spec.whatwg.org/#ws-class">WritableStream</a> <a class="nv idl-code" data-link-type="attribute" data-readonly="" data-type="WritableStream" href="#dom-textdecoder-writable">writable</a>;
</pre>

<p class="addition">to the TextDecoder interface.

<p class="addition">In the paragraph following the IDL, insert ", and <dfn data-dfn-for="TextDecoder" data-dfn-type="dfn" data-noexport="" id="textdecoder-transform">transform<a class="self-link" href="#textdecoder-transform"></a></dfn>" at the end of the sentence.

<p class="addition">To the DOM intro note, add

<p><dl class="domintro">
   <dt><code><var>decoder</var> . <a class="idl-code" data-link-type="attribute" href="#dom-textdecoder-readable">readable</a></code>
    <dd>
     <p>Returns the result of running <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-encoding">encoding</a>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#decoder">decoder</a> on the
  chunks written to <a class="idl-code" data-link-type="attribute" href="#dom-textdecoder-writable">writable</a>. Chunks read from <a class="idl-code" data-link-type="attribute" href="#dom-textdecoder-readable">readable</a> will always be strings. </p>
    <dt><code><var>decoder</var> . <a class="idl-code" data-link-type="attribute" href="#dom-textdecoder-writable">writable</a></code>
    <dd>
     <p>Accepts <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#BufferSource" id="ref-for-BufferSource①">BufferSource</a></code> chunks and runs them through <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-encoding" id="ref-for-textdecoder-encoding③">encoding</a>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#decoder" id="ref-for-decoder①②">decoder</a> before making them available to <a class="idl-code" data-link-type="attribute" href="#dom-textdecoder-readable" id="ref-for-dom-textdecoder-readable③">readable</a>. Typically this will be used via the <code class="idl"><a data-link-type="idl" href="https://streams.spec.whatwg.org/#rs-pipe-through" id="ref-for-rs-pipe-through">pipeThrough()</a></code> method on a <a data-link-type="idl" href="https://streams.spec.whatwg.org/#rs-class" id="ref-for-rs-class①">ReadableStream</a> source. </p>
<pre class="example" id="example-textdecode-writable"><a class="self-link" href="#example-textdecode-writable"></a>var decoder = new TextDecoder(encoding);
byteReadable
  .pipeThrough(decoder)
  .pipeTo(textWritable);</pre>
    <p>If the <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-error-mode" id="ref-for-textdecoder-error-mode①">error mode</a> is "<code>fatal</code>" and <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-encoding" id="ref-for-textdecoder-encoding④">encoding</a>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#decoder" id="ref-for-decoder①③">decoder</a> returns <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#error" id="ref-for-error④">error</a>, both <a class="idl-code" data-link-type="attribute" href="#dom-textdecoder-readable" id="ref-for-dom-textdecoder-readable④">readable</a> and <a class="idl-code" data-link-type="attribute" href="#dom-textdecoder-writable" id="ref-for-dom-textdecoder-writable③">writable</a> will be
  errored with a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror">TypeError</a></code>. </p>
</dl>

<p class="addition">To the <dfn class="idl-code" data-dfn-for="TextDecoder" data-dfn-type="constructor" data-export="" id="dom-textdecoder"><code>TextDecoder(<var>label</var>, <var>options</var>)</code><a class="self-link" href="#dom-textdecoder"></a></dfn> constructor steps, before the final step, add:
<ol start="7">
      <li>
     <p>Let <var>transformer</var> be a new object. </p>
    <li>
    <p>Set <var>transformer</var>["transform"] to a function which takes <var>chunk</var>, <var>controller</var> arguments and runs the <a data-link-type="dfn" href="#concept-td-decode-and-enqueue">decode and enqueue a chunk</a> algorithm with <var>dec</var>, <var>chunk</var> and <var>controller</var>. </p>
     <li>
      <p>Set <var>transformer</var>["flush"] to a function which takes a <var>controller</var> argument and runs the <a data-link-type="dfn" href="#concept-td-flush-and-enqueue">flush and enqueue</a> algorithm with <var>dec</var> and <var>controller</var>. </p>

    <li>
     <p>Let <var>transform</var> be the result of calling the initial value of <a data-link-type="idl" href="https://streams.spec.whatwg.org/#ts" id="ref-for-ts">TransformStream</a> as a constructor with <var>transformer</var>. </p>
    <li>
     <p>Set <var>dec</var>’s <a data-link-type="dfn" href="#textdecoder-transform">transform</a> to <var>transform</var>. </p>
</ol>

<p class="addition">After the description of the ignoreBOM attribute, add:

    <p>The <dfn class="idl-code" data-dfn-for="TextDecoder" data-dfn-type="attribute" data-export="" id="dom-textdecoder-readable"><code>readable</code><a class="self-link" href="#dom-textdecoder-readable"></a></dfn> attribute’s getter must return the <code>readable</code> attribute of <a data-link-type="dfn" href="#textdecoder-transform">transform</a>. </p>
   <p>The <dfn class="idl-code" data-dfn-for="TextDecoder" data-dfn-type="attribute" data-export="" id="dom-textdecoder-writable"><code>writable</code><a class="self-link" href="#dom-textdecoder-writable"></a></dfn> attribute’s getter must return the <code>writable</code> attribute of <a data-link-type="dfn" href="#textdecoder-transform">transform</a>. </p>

<p class="addition">At the beginning of the steps for the decode() method, add:

  <ol>
    <li>
     <p>If <a data-link-type="dfn" href="#textdecoder-transform" id="ref-for-textdecoder-transform③">transform</a>’s <code>readable</code> is <a data-link-type="dfn" href="https://streams.spec.whatwg.org/#locking" id="ref-for-locking">locked</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw" id="ref-for-dfn-throw③">throw</a> a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror②">TypeError</a></code> exception. </p>
    <li>
     <p>If <a data-link-type="dfn" href="#textdecoder-transform" id="ref-for-textdecoder-transform④">transform</a>’s <code>writable</code> is <a data-link-type="dfn" href="https://streams.spec.whatwg.org/#locking" id="ref-for-locking①">locked</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw" id="ref-for-dfn-throw④">throw</a> a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror③">TypeError</a></code> exception. </p>
     <p class="note" role="note">These steps ensure that the state of the <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#decoder">decoder</a> is not simultaneously modified by
 the Streams API and this method. </p>
</ol>

<p class="addition">After the definition of the decode() method, add:

   <p>The <dfn data-dfn-type="dfn" data-noexport="" id="concept-td-decode-and-enqueue">decode and enqueue a chunk<a class="self-link" href="#concept-td-decode-and-enqueue"></a></dfn> algorithm, given a <a data-link-type="idl" href="https://encoding.spec.whatwg.org/#textdecoder">TextDecoder</a> <var>dec</var>, a <var>chunk</var> and a <var>controller</var>, runs these
steps: </p>
   <ol>
    <li>
     <p>If the <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values" id="ref-for-sec-ecmascript-data-types-and-values">type</a> of of <var>chunk</var> is not Object, or <var>chunk</var> does not have an
  [[ArrayBufferData]] <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-object-internal-methods-and-internal-slots" id="ref-for-sec-object-internal-methods-and-internal-slots">internal slot</a>, or <a data-link-type="abstract-op" href="https://tc39.github.io/ecma262/#sec-isdetachedbuffer" id="ref-for-sec-isdetachedbuffer">IsDetachedBuffer</a>(<var>chunk</var>) is
  true, or <a data-link-type="abstract-op" href="https://tc39.github.io/ecma262/#sec-issharedarraybuffer" id="ref-for-sec-issharedarraybuffer">IsSharedArrayBuffer</a>(<var>chunk</var>) is true then <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw" id="ref-for-dfn-throw⑥">throw</a> a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑤">TypeError</a></code>. </p>
    <li>
     <p>Assert: <a data-link-type="abstract-op" href="https://streams.spec.whatwg.org/#is-transform-stream-default-controller" id="ref-for-is-transform-stream-default-controller">IsTransformStreamDefaultController</a>(<var>controller</var>) is true. </p>
    <li>
     <p>If the <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-do-not-flush-flag">do not flush flag</a> for <var>dec</var> is unset, set <var>dec’s</var> <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-decoder">decoder</a> to a new <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#decoder">decoder</a> for <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-encoding">encoding</a>, set <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-stream">stream</a> to a new <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream">stream</a>, and unset <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-bom-seen-flag">BOM seen flag</a>. </p>
    <li>
     <p>Set <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-do-not-flush-flag">do not flush flag</a>. </p>
    <li>
     <p><a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream-push">Push</a> a <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-get-buffer-source-copy">copy of</a> <var>chunk</var> to <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-stream">stream</a>. </p>
    <li>
     <p>Let <var>output</var> be a new <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream">stream</a>. </p>
    <li>
     <p>While true, run these substeps: </p>
     <ol>
      <li>
       <p>Let <var>token</var> be the result of <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream-read">reading</a> from <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-stream">stream</a>. </p>
      <li>
       <p>If <var>token</var> is <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#end-of-stream">end-of-stream</a>, run these substeps: </p>
       <ol>
        <li>
        <p>Let <var>outputChunk</var> be <var>output</var>, <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-td-serialize" id="ref-for-concept-td-serialize②">serialized</a>. </p>
        <li>
         <p>Call <a data-link-type="abstract-op" href="https://streams.spec.whatwg.org/#transform-stream-default-controller-enqueue" id="ref-for-transform-stream-default-controller-enqueue">TransformStreamDefaultControllerEnqueue</a>(<var>controller</var>, <var>outputChunk</var>). </p>
        <li>
         <p>Return. </p>
       </ol>
      <li>
       <p>Let <var>result</var> be the result of <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-encoding-process">processing</a> <var>token</var> for <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-decoder">decoder</a>, <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-stream">stream</a>, <var>output</var>, and <var>dec’s</var> <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-error-mode">error mode</a>. </p>
      <li>
       <p>If <var>result</var> is <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#error">error</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#exceptiondef-typeerror">TypeError</a></code> exception. </p>
     </ol>
   </ol>
   <p>The <dfn data-dfn-type="dfn" data-noexport="" id="concept-td-flush-and-enqueue">flush and enqueue<a class="self-link" href="#concept-td-flush-and-enqueue"></a></dfn> algorithm, which handles the end
of data from the input <a data-link-type="idl" href="https://streams.spec.whatwg.org/#rs-class">ReadableStream</a>, given a <a data-link-type="idl" href="https://encoding.spec.whatwg.org/#textdecoder">TextDecoder</a> <var>dec</var> and
a <var>controller</var> runs these steps: </p>
   <ol>
    <li>
     <p>Assert: <a data-link-type="abstract-op" href="https://streams.spec.whatwg.org/#is-transform-stream-default-controller" id="ref-for-is-transform-stream-default-controller①">IsTransformStreamDefaultController</a>(<var>controller</var>) is true. </p>
    <li>
     <p>If the <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-do-not-flush-flag">do not flush flag</a> for <var>dec</var> is unset, set <var>dec’s</var> <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-decoder">decoder</a> to a new <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#decoder">decoder</a> for <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-encoding">encoding</a>, set <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-stream">stream</a> to a new <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream">stream</a>, and unset <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-bom-seen-flag">BOM seen flag</a>. </p>
    <li>
     <p>Unset <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-do-not-flush-flag">do not flush flag</a>. </p>
    <li>
     <p>Let <var>output</var> be a new <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream">stream</a>. </p>
    <li>
     <p>Let <var>result</var> be the result of <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-encoding-process">processing</a> <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#end-of-stream">end-of-stream</a> for <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-decoder">decoder</a> and <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-stream">stream</a>, <var>output</var>, and <var>dec</var>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#textdecoder-error-mode">error mode</a>. </p>
    <li>
     <p>If <var>result</var> is <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#finished">finished</a>, run these substeps:</p>
     <ol>
      <li>
       <p>Let <var>outputChunk</var> be <var>output</var>, <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-td-serialize" id="ref-for-concept-td-serialize③">serialized</a>. </p>
      <li>
       <p>Call <a data-link-type="abstract-op" href="https://streams.spec.whatwg.org/#transform-stream-default-controller-enqueue" id="ref-for-transform-stream-default-controller-enqueue①">TransformStreamDefaultControllerEnqueue</a>(<var>controller</var>, <var>outputChunk</var>). </p>
      <li>
       <p>Return. </p>
     </ol>
    <li>
     <p>Otherwise, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#exceptiondef-typeerror">TypeError</a></code>. </p>
   </ol>

<h3>In 8.2 Interface <code title="">TextEncoder</code>, add:</h3>

<p class="addition">In the IDL, add

<p><pre class="idl highlight def">
  <span class="kt">readonly</span> <span class="kt">attribute</span> <a class="n" data-link-type="idl-name" href="https://streams.spec.whatwg.org/#rs-class">ReadableStream</a> <a class="nv idl-code" data-link-type="attribute" data-readonly="" data-type="ReadableStream" href="#dom-textencoder-readable">readable</a>;
  <span class="kt">readonly</span> <span class="kt">attribute</span> <a class="n" data-link-type="idl-name" href="https://streams.spec.whatwg.org/#ws-class">WritableStream</a> <a class="nv idl-code" data-link-type="attribute" data-readonly="" data-type="WritableStream" href="#dom-textencoder-writable">writable</a>;
</pre>

<p class="addition">to the TextEncoder interface.

<p class="addition">In the paragraph following the IDL, insert " and <dfn data-dfn-for="TextEncoder" data-dfn-type="dfn" data-noexport="" id="textencoder-transform">transform<a class="self-link" href="#textencoder-transform"></a></dfn>" at the end of the sentence.

<p class="addition">To the DOM intro note, add

<p><dl class="domintro">
    <dt><code><var>encoder</var> . <a class="idl-code" data-link-type="attribute" href="#dom-textencoder-readable">readable</a></code>
    <dd>
     <p>Returns the result of running <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#utf-8">UTF-8</a>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#encoder">encoder</a> on the
  chunks written to <a class="idl-code" data-link-type="attribute" href="#dom-textencoder-writable">writable</a>. Chunks read from <a class="idl-code" data-link-type="attribute" href="#dom-textencoder-readable">readable</a> will always have type <a data-link-type="idl" href="https://heycam.github.io/webidl/#idl-Uint8Array">Uint8Array</a>. </p>
    <dt><code><var>encoder</var> . <a class="idl-code" data-link-type="attribute" href="#dom-textencoder-writable">writable</a></code>
    <dd>
     <p>Accepts <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#idl-USVString">USVString</a></code> chunks and runs them through <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#utf-8">UTF-8</a>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#encoder">encoder</a> before making them available to <a class="idl-code" data-link-type="attribute" href="#dom-textencoder-readable">readable</a>. Typically this will be
  used via the <code class="idl"><a data-link-type="idl" href="https://streams.spec.whatwg.org/#rs-pipe-through" id="ref-for-rs-pipe-through①">pipeThrough()</a></code> method on a <a data-link-type="idl" href="https://streams.spec.whatwg.org/#rs-class" id="ref-for-rs-class④">ReadableStream</a> source. </p>
<pre class="example" id="example-textencode-writable"><a class="self-link" href="#example-textencode-writable"></a>textReadable
  .pipeThrough(new TextEncoder())
  .pipeTo(byteWritable);</pre>
</dl>

<p class="addition">To the <dfn class="idl-code" data-dfn-for="TextEncoder" data-dfn-type="constructor" data-export="" id="dom-textencoder"><code>TextEncoder()</code><a class="self-link" href="#dom-textencoder"></a></dfn> constructor steps, before the final step, add:

  <ol start="3">
      <li>
     <p>Let <var>transformer</var> be a new object. </p>
    <li>
     <p>Set <var>transformer</var>["transform"] to a function which takes <var>chunk</var>, <var>controller</var> arguments and runs the <a data-link-type="dfn" href="#concept-td-encode-and-enqueue">encode and enqueue a chunk</a> algorithm with <var>chunk</var> and <var>controller</var>. </p>
    <li>
     <p>Let <var>transform</var> be the result of calling the initial value of <a data-link-type="idl" href="https://streams.spec.whatwg.org/#ts" id="ref-for-ts①">TransformStream</a> as a constructor with <var>transformer</var>. </p>
    <li>
     <p>Set <var>dec</var>’s <a data-link-type="dfn" href="#textencoder-transform">transform</a> to <var>transform</var> </p>
</ol>

<p class="addition">After the description of the encoding attribute, add:

     <p>The <dfn class="idl-code" data-dfn-for="TextEncoder" data-dfn-type="attribute" data-export="" id="dom-textencoder-readable"><code>readable</code><a class="self-link" href="#dom-textencoder-readable"></a></dfn> attribute’s getter must return the <code>readable</code> attribute of <a data-link-type="dfn" href="#textencoder-transform">transform</a>. </p>
   <p>The <dfn class="idl-code" data-dfn-for="TextEncoder" data-dfn-type="attribute" data-export="" id="dom-textencoder-writable"><code>writable</code><a class="self-link" href="#dom-textencoder-writable"></a></dfn> attribute’s getter must return the <code>writable</code> attribute of <a data-link-type="dfn" href="#textencoder-transform">transform</a>. </p>

<p class="addition">At the beginning of the steps for the encode() method, add:
  <ol>
    <li>
     <p>If <a data-link-type="dfn" href="#textencoder-transform" id="ref-for-textencoder-transform③">transform</a>’s <code>readable</code> is <a data-link-type="dfn" href="https://streams.spec.whatwg.org/#locking" id="ref-for-locking②">locked</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw" id="ref-for-dfn-throw⑨">throw</a> a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑧">TypeError</a></code> exception. </p>
    <li>
     <p>If <a data-link-type="dfn" href="#textencoder-transform" id="ref-for-textencoder-transform④">transform</a>’s <code>writable</code> is <a data-link-type="dfn" href="https://streams.spec.whatwg.org/#locking" id="ref-for-locking③">locked</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw" id="ref-for-dfn-throw①⓪">throw</a> a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑨">TypeError</a></code> exception. </p>
     <p class="note" role="note">These steps are for consistent behaviour with the <a data-link-type="idl" href="https://encoding.spec.whatwg.org/#textdecoder">TextDecoder</a> <a class="idl-code" data-link-type="method" href="https://encoding.spec.whatwg.org/#dom-textdecoder-decode"><code>decode(<var>input</var>)</code></a> method. </p>
</ol>


<p class="addition">After the definition of the encode() method, add:

   <p>The <dfn data-dfn-type="dfn" data-noexport="" id="concept-td-encode-and-enqueue">encode and enqueue a chunk<a class="self-link" href="#concept-td-encode-and-enqueue"></a></dfn> algorithm, given a <var>chunk</var> and <var>controller</var>, runs these steps: </p>
   <ol>
    <li>
     <p>Let <var>input</var> be the result of <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-convert-ecmascript-to-idl-value">converting</a> <var>chunk</var> to a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#idl-USVString">USVString</a></code>. </p>
    <li>
     <p>Assert: <a data-link-type="abstract-op" href="https://streams.spec.whatwg.org/#is-transform-stream-default-controller" id="ref-for-is-transform-stream-default-controller②">IsTransformStreamDefaultController</a>(<var>controller</var>) is true. </p>
    <li>
     <p>Convert <var>input</var> to a <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream">stream</a>. </p>
    <li>
     <p>Let <var>output</var> be a new <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream">stream</a>. </p>
    <li>
     <p>Let <var>encoder</var> be <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#utf-8">UTF-8</a>’s <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#encoder">encoder</a>. </p>
    <li>
     <p>While true, run these substeps: </p>
     <ol>
      <li>
       <p>Let <var>token</var> be the result of <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-stream-read">reading</a> from <var>input</var>. </p>
      <li>
       <p>Let <var>result</var> be the result of <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#concept-encoding-process">processing</a> <var>token</var> for <var>encoder</var>, <var>input</var>, <var>output</var>. </p>
      <li>
       <p>If <var>result</var> is <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#finished">finished</a>, run these substeps: </p>
       <ol>
        <li>
         <p>Convert <var>output</var> into a byte sequence. </p>
        <li>
         <p>Call <a data-link-type="abstract-op" href="https://streams.spec.whatwg.org/#transform-stream-default-controller-enqueue" id="ref-for-transform-stream-default-controller-enqueue②">TransformStreamDefaultControllerEnqueue</a>(<var>controller</var>, <var>output</var>). </p>
        <li>
         <p>Return. </p>
       </ol>
     </ol>
   </ol>
